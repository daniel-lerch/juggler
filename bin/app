#!/usr/bin/env bash

function help() {
    cat <<EOT
Juggler CLI
Usage:  app [OPTION]... <command>

Commands:
  up [-f]       Create containers and start them
  down          Stop and delete containers
  update [-r]   Build or pull images
  start
  restart
  stop
  exec
  logs

Options:
  -a            Manage all applications installed on this system
  -n <name>     Manage an application with the specified project name
  -h            Show this help message

EOT
}

function about_help() {
    echo "Run app -h for more information."
}

function try_find_directory() {
    local workdir=$(pwd)
    while true; do
        if [[ $workdir == "/" ]]; then
            break
        elif [[ -e "$workdir/docker-compose.yml" ]]; then
            DIRECTORY=$workdir
            break
        else
            workdir=$(dirname $workdir)
        fi
    done
}

function foreach_invoke() {
    for directory in /opt/*/*; do
        [[ ! -e $directory/docker-compose.yml ]] && continue
        init $directory
        echo "Processing $PROJECT_TITLE..."
        execute_command $@
    done
}

function execute_command() {
    local command=$1
    shift
    eval "cmd_$command" "\$@"
}

function cmd_backup() {
    # Load external backup module
    if [[ -z $JUGGLER_CONFIG_FILE ]]; then
        echo "The JUGGLER_CONFIG_FILE variable is not set"
        exit 1
    elif [[ ! -e $JUGGLER_CONFIG_FILE ]]; then
        echo "No Juggler config file found at $JUGGLER_CONFIG_FILE"
        exit 1
    fi
    source $JUGGLER_CONFIG_FILE
    source /opt/juggler/lib/backup.sh
    backup_main $@
}

function main() {
    local all=0
    local named=0
    local help=0
    while getopts ":an:h" arg; do
        case $arg in
            a)
                if [[ $named == 1 ]]; then
                    echo "Options 'a' and 'n' are mutually exclusive."
                    about_help
                    exit 1
                else
                    all=1
                fi
                ;;
            n)
                if [[ $all == 1 ]]; then
                    echo "Options 'a' and 'n' are mutually exclusive."
                    about_help
                    exit 1
                else
                    named=1
                fi

                # getopts ensures that $OPTARG is not empty
                DIRECTORY="/opt/$OPTARG"
                if [[ ! -d $DIRECTORY ]]; then
                    echo "Directory not found: $DIRECTORY"
                    exit 1
                elif [[ ! -e "$DIRECTORY/docker-compose.yml" ]]; then
                    echo "No compose file found in $DIRECTORY"
                    exit 1
                fi
                ;;
            h)
                help=1
                ;;
            \?)
                echo "Invalid option: '$OPTARG'"
                about_help
                exit 1
                ;;
            :)
                echo "Invalid option: '$OPTARG' requires an argument"
                about_help
                exit 1
                ;;
        esac
    done
    shift $((OPTIND-1))

    if [[ $all == 0 && $named == 0 ]]; then
        try_find_directory
    fi

    # Load core script which implements all commands
    source /opt/juggler/lib/core.sh

    if [[ ! -z $DIRECTORY ]]; then
        init $DIRECTORY
    fi

    if [[ $help == 1 ]]; then
        help
        exit 0
    fi

    if [[ -z $1 ]]; then
        echo "Missing command"
        about_help
        exit 1
    fi

    declare -F "cmd_$1" > /dev/null
    if [[ $? != 0 ]]; then
        echo "Invalid command: '$1'"
        about_help
        exit 1
    fi

    if [[ $all == 1 ]]; then
        foreach_invoke $@
        exit 0
    fi

    if [[ -z $DIRECTORY ]]; then
        echo "No compose file found in this directory and its parents"
        exit 1
    fi

    execute_command $@
    exit 0
}

main $@

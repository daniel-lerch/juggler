# Juggler

## Install
1. `git clone https://github.com/daniel-lerch/juggler.git /opt/juggler`
2. Add `/opt/juggler/bin` to _PATH_ permanently for all users
3. Set _JUGGLER\_CONFIG\_FILE_ permanently for all users (read more about config below)

## Manage an application

### Variables
- `PROJECT_DIR` e.g. _/opt/global/nginx_
- `PROJECT_NAME` e.g. _nginx_
- `PROJECT_GROUP` e.g. _global_
- `PROJECT_TITLE` e.g. _global/nginx_
- `COMPOSE_FILE` e.g. _/opt/global/nginx/docker-compose.yml_
- `COMPOSE_PROJECT_NAME` e.g. _global-nginx_
- `APP_CONTAINER_NAME` e.g. _global-nginx-app_

Set the following variables to use the `execdb` command:
- `MYSQL_DATABASE`
- `MYSQL_USER`
- `MYSQL_PASSWORD`

Set the following variables for automatic MySQL dumps and mount `/var/opt/backup`:
- `MYSQL_DATABASE`
- `MYSQL_ROOT_PASSWORD`

### Functions
- `invoke_composer()` (exposed) Invokes _docker-compose_ with all required options
- `update_images()` (optional callback) Builds custom images and pull images
- `prepare_backup()` (optional callback) Exports data before Borg backup starts

### Example
Nextcloud (located in `/opt/church/nextcloud`)

- `juggler.sh` Custom functions and environment variables
```bash
APP_IMAGE=nextcloud:latest

DB_IMAGE=mariadb:latest
DB_CONTAINER_NAME=$COMPOSE_PROJECT_NAME-db

MYSQL_ROOT_PASSWORD=root
MYSQL_DATABASE=nextcloud
MYSQL_USER=nextcloud
MYSQL_PASSWORD=password

function cmd_execw() {
    invoke_composer exec -u www-data app bash
}
```
- `.env` Environment file generated by Juggler
- `docker-compose.yml` Compose file template using variables
```yaml
version: '2.1'

services:
  app:
    image: ${APP_IMAGE}
    container_name: ${APP_CONTAINER_NAME}
    environment:
      - MYSQL_DATABASE
      - MYSQL_USER
      - MYSQL_PASSWORD
      - MYSQL_HOST=db
  db:
    image: ${DB_IMAGE}
    container_name: ${DB_CONTAINER_NAME}
    environment:
      - MYSQL_ROOT_PASSWORD
      - MYSQL_DATABASE
      - MYSQL_USER
      - MYSQL_PASSWORD
```
- _$JUGGLER\_CONFIG\_FILE_ Global Juggler config file
```bash
# Change this variable to set custom default backup target
BACKUP_TARGET_DEFAULT="/var/opt/backup"
BACKUP_TARGET_DEFAULT_ENCRYPTION="none"
BACKUP_TARGET_DEFAULT_PASSPHRASE=""
# Add additional targets that can be selected manually
BACKUP_TARGET_REMOTE="backup@example.com:/var/opt/backup"
BACKUP_TARGET_REMOTE_ENCRYPTION="repokey"
BACKUP_TARGET_REMOTE_PASSPHRASE="password"
```

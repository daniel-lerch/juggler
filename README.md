# Juggler

## Install
1. `git clone https://github.com/daniel-lerch/juggler.git /opt/juggler`
2. Add `/opt/juggler/bin` to _PATH_ permanently for all users
3. Set _JUGGLER\_CONFIG\_FILE_ permanently for all users (read more about config below)

## Structure
Juggler consists out of four main components:
1. `bin/app` the bootstrapper executable
2. `lib/core.sh` the core module
3. `lib/compose.sh` the Docker Compose module
4. `lib/backup.sh` the Borg Backup module

Major challenges with Bash for a complex framework like Juggler
- Parse variables from `docker-compose.yml` files. Solution: Implemented in an external Python script.
- Juggler cannot iterate through multiple apps because of dangling variables. Solution: Start an own Juggler process for each app.
- Creating a good help overview requires lots of additional functions. Solution: Only show compose commands and backup module.
- For multiple apps it is hard to determine whether a command is available.

## Variables and functions

### Core module
Exposed variables:
- `PROJECT_DIR` e.g. _/opt/global/nginx_
- `PROJECT_NAME` e.g. _nginx_
- `PROJECT_GROUP` e.g. _global_
- `PROJECT_TITLE` e.g. _global/nginx_
- `PROJECT_FULLNAME` e.g. _global-nginx_

### Docker Compose module
Exposed variables:
- `COMPOSE_PROJECT_NAME` alias for _PROJECT\_FULLNAME_
- `COMPOSE_FILE` e.g. _/opt/global/nginx/docker-compose.yml_
- `APP_CONTAINER_NAME` e.g. _global-nginx-app_

Optional variables (for `execdb` command):
- `MYSQL_DATABASE`
- `MYSQL_USER`
- `MYSQL_PASSWORD`

Exposed functions:
- `invoke_composer()` Invokes _docker-compose_ with all required options

Optional callbacks:
- `update_images()` (optional callback) Builds custom images and pull images

### Borg Backup module
Exposed variables (change to customize behavior):
- `BACKUP_DIRS` e.g. _/opt/global/nginx_
- `BACKUP_EXCLUDE` e.g. _/opt/global/nginx/log_

Optional variables (for automatic MySQL dumps to `/var/opt/backup`):
- `MYSQL_DATABASE`
- `MYSQL_ROOT_PASSWORD`

Optional callbacks:
- `prepare_backup()` Exports data before Borg backup starts

## Example
Nextcloud (located in `/opt/church/nextcloud`)

- `juggler.sh` Custom functions and environment variables
```bash
APP_IMAGE=nextcloud:latest

DB_IMAGE=mariadb:latest
DB_CONTAINER_NAME=$COMPOSE_PROJECT_NAME-db

MYSQL_ROOT_PASSWORD=root
MYSQL_DATABASE=nextcloud
MYSQL_USER=nextcloud
MYSQL_PASSWORD=password

function cmd_execw() {
    invoke_composer exec -u www-data app bash
}
```
- `.env` Environment file generated by Juggler
- `docker-compose.yml` Compose file template using variables
```yaml
version: '2.1'

services:
  app:
    image: ${APP_IMAGE}
    container_name: ${APP_CONTAINER_NAME}
    environment:
      - MYSQL_DATABASE
      - MYSQL_USER
      - MYSQL_PASSWORD
      - MYSQL_HOST=db
  db:
    image: ${DB_IMAGE}
    container_name: ${DB_CONTAINER_NAME}
    environment:
      - MYSQL_ROOT_PASSWORD
      - MYSQL_DATABASE
      - MYSQL_USER
      - MYSQL_PASSWORD
```
- _$JUGGLER\_CONFIG\_FILE_ Global Juggler config file
```bash
# Change this variable to set custom default backup target
BACKUP_TARGET_DEFAULT="/var/opt/backup"
BACKUP_TARGET_DEFAULT_ENCRYPTION="none"
BACKUP_TARGET_DEFAULT_PASSPHRASE=""
# Add additional targets that can be selected manually
BACKUP_TARGET_REMOTE="backup@example.com:/var/opt/backup"
BACKUP_TARGET_REMOTE_ENCRYPTION="repokey"
BACKUP_TARGET_REMOTE_PASSPHRASE="password"
```
